# V2 沿牆控制優化方案分析報告

生成時間: 2025-12-06
分析者: Claude Code PFC

## 執行摘要

**結論**: 用戶提出的方案**基本合理**，但需要針對現實條件做關鍵修正。

**核心問題**: 當前 V2 使用超聲波 Bang-Bang 控制導致 C 字形震盪軌跡，不符合直線行駛需求。

**用戶提出的解決方案**:
1. 用 MPU6050 IMU 實現 PID 航向控制保持直線
2. 超聲波只負責：偵測是否走斜、快撞牆時轉彎
3. 紅色由 RPi 告知，Arduino 只需關吸塵器
4. 入口時寫死：進場 → 轉向右下角
5. 其他都交由實時判斷，不寫死路徑

---

## 1. 可行性分析

### 1.1 MPU6050 航向控制 - 可行，但需注意限制

#### 優勢
- **更新率優勢**: MPU6050 可達 50Hz，遠高於超聲波的 ~10Hz
- **短期精度**: 陀螺儀積分在短時間內（幾分鐘）精度良好
- **已有實現**: 代碼中已實現 IMU 讀取和 Yaw 積分
  ```cpp
  // mpu6050_sensor.cpp: L114
  _yaw += _gyroZ * dt;  // 陀螺儀積分
  ```

#### 限制與風險
1. **長期漂移**: 陀螺儀積分會累積誤差，Yaw 角度會漂移
   - 比賽時長如果超過 3-5 分鐘，漂移可能達到 5-10 度
   - **需要定期校正**，建議每次轉彎後重置目標航向

2. **初始對齊問題**: 車體啟動時的 Yaw=0 不一定是場地對齊的方向
   - 需要在入場後第一次轉彎時「對齊」航向基準
   - 例如：轉向右下角後，鎖定當前 Yaw 為新基準

3. **振動干擾**: 馬達運轉、場地顛簸會引入高頻噪音
   - 已有中值濾波，但可能需要加低通濾波
   - 建議調參時監控實際 Yaw 噪音水平

#### 建議實現策略
```
航向控制邏輯：
1. 啟動時 Yaw=0（隨機方向）
2. 入場 → 轉向右下角（85度轉彎）
3. 轉彎完成後：鎖定當前 Yaw 為目標航向（targetYaw）
4. 直行時：PID 修正 (currentYaw - targetYaw)
5. 每次轉彎後：重置 targetYaw = currentYaw（避免漂移累積）
```

**評估**: ✅ 可行，但需要定期重置航向基準

---

### 1.2 超聲波角色調整 - 合理

#### 當前問題
查看 `wall_follower.cpp: L220-248`，當前使用 Bang-Bang 控制：
```cpp
// 行為 2: 沿牆控制 (緩慢修正)
if (right >= 2 && right < 100) {
    float error = right - TARGET_RIGHT_DIST;
    if (abs(error) < ERROR_DEADZONE) {
        wallAngular = 0;  // 死區內：直走
    }
    else if (error > 0) {
        wallAngular = -GENTLE_ANGULAR;  // 太遠：右轉
    }
    else {
        wallAngular = GENTLE_ANGULAR;  // 太近：左轉
    }
}
```
- 問題：只有三個檔位（左轉/直走/右轉），導致震盪
- 改善空間：改用 IMU 航向控制，超聲波只負責「偏離警告」

#### 用戶提案：超聲波僅用於
1. **偵測是否走斜** - 例如 right_dist 持續變大/變小 → 說明在偏離
2. **快撞牆時轉彎** - front_dist < 20cm → 角落轉彎

#### 評估
✅ **合理**，超聲波的低更新率和噪音確實不適合做精細的閉環控制

建議角色分工：
- **IMU**: 主控（航向鎖定，保持直線）
- **超聲波（右側）**: 監督（偏離警告，輔助修正）
- **超聲波（前方）**: 障礙偵測（角落轉彎觸發）

---

### 1.3 紅色處理策略 - 已實現，合理

查看 `controller.py: L202-257`，當前實現：
```python
if red_now:
    strategy = cfg.RED_AVOID_STRATEGY
    if strategy == "vacuum_off":
        print(f"[Controller] 偵測到紅色區域，關閉吸塵器")
        self.send_set_vacuum(False)
    else:  # "turn_avoid"
        print(f"[Controller] 偵測到紅色區域，發送避障指令")
        self.send_avoid_red()
```

#### 當前配置
`config.py: L54` - `RED_AVOID_STRATEGY = "vacuum_off"`
- 遇到紅色時只關吸塵器，繼續沿牆
- 紅色消失後延遲 1.5 秒重開吸塵器

✅ **已實現，符合用戶需求**

---

### 1.4 入口策略 - 需要硬編碼

用戶提出：「入口時寫死：進場 → 轉向右下角」

#### 當前狀態
查看代碼，**尚未實現明確的入口邏輯**。

當前 `wall_follower.cpp` 的 `start()` 只是：
```cpp
void WallFollower::start() {
    _running = true;
    _cornerCount = 0;
    _cornerLocked = false;
    // ...
}
```
沒有「進場後先轉向右下角」的邏輯。

#### 建議實現
在 Arduino 端或 Pi 端加入**進場狀態機**：
```
狀態 0: IDLE（待機）
  ↓ 收到 CMD_START
狀態 1: ENTER（進場）
  - 前進固定距離（例如 50cm）或固定時間（2秒）
  ↓ 距離/時間達成
狀態 2: TURN_TO_CORNER（轉向右下角）
  - IMU 左轉 85 度
  ↓ 轉彎完成
狀態 3: WALL_FOLLOW（沿牆模式）
  - 啟用 IMU 航向鎖定
  - 開始計數角落
```

**評估**: ✅ 合理，但需要額外實現

---

### 1.5 實時判斷 vs 寫死路徑

用戶提出：「其他都交由實時判斷，不寫死路徑」

#### 分析
- **優點**: 適應性強，可應對紅色區域隨機擺放
- **缺點**: 可能遇到「死角」或「繞圈」問題

#### 潛在風險場景
1. **L 型死角**: 車子走進 L 型區域，無法辨識已經走過
2. **繞圈**: 沿牆走一圈後回到起點，無法判斷「完成」
3. **紅色區域阻擋**: 紅色區域剛好在轉角，導致路徑阻斷

#### 建議補充邏輯
1. **角落計數停止**: 例如走完 4 個角落後停止（假設矩形場地）
2. **時間保護**: 例如 5 分鐘後強制停止（避免無限繞圈）
3. **覆蓋率估計**: 如果有里程計，可估算已覆蓋面積

**評估**: ⚠️ 需要補充停止條件，避免無限執行

---

## 2. 潛在問題與風險

### 2.1 IMU 漂移問題（高風險）

**問題描述**:
陀螺儀積分會累積誤差，例如：
- 理論直行：Yaw 保持 0 度
- 實際結果：Yaw 每分鐘漂移 1-3 度

**影響**:
- 3 分鐘後，目標航向可能偏離 5-10 度
- 車子會逐漸偏離牆壁，進入場地中央

**解決方案**:
1. **定期重置**: 每次轉彎後重置 targetYaw = currentYaw
2. **超聲波校正**: 如果 right_dist 持續偏離目標，微調 targetYaw
3. **加速度計融合**: 使用加速度計的 Pitch/Roll 輔助校正（需額外實現）

#### 建議實現（混合控制）
```
主控: IMU 航向鎖定（保持直線）
監督: 超聲波右側距離
  - 如果 right_dist 持續 > 目標 + 5cm（連續 2 秒）
    → 說明 Yaw 漂移了，微調 targetYaw -= 1 度
  - 如果 right_dist 持續 < 目標 - 5cm
    → 微調 targetYaw += 1 度
```

---

### 2.2 超聲波噪音與誤判（中風險）

**問題描述**:
超聲波在以下情況會出錯：
1. 斜角牆壁 → 聲波反射偏離
2. 牆壁材質吸音 → 讀數跳動
3. 多重反射 → 錯誤的距離值

**當前緩解**:
查看 `wall_follower.cpp: L299-343`，已有中值濾波：
```cpp
int WallFollower::_filterSensor(int value, int* history) {
    // 中值濾波 - 取 3 個值的中位數
    // ...
}
```

**建議加強**:
1. **異常值檢測**: 如果讀數突變 > 20cm，視為無效
2. **連續性檢查**: 只有連續 3 次讀數都 < 20cm 才觸發轉彎
3. **融合前方+右側**: 角落判斷時同時檢查兩個感測器

---

### 2.3 比賽場地特性（高風險）

**未知變數**:
用戶提供的場地資訊有限，以下可能影響策略：
1. **牆壁高度**: 如果牆壁很矮（< 20cm），超聲波可能測不到
2. **地面顏色**: 如果地面也是紅色，會誤判
3. **起點位置**: 如果起點不在場外，入場邏輯失效
4. **紅色區域大小**: 如果紅色區域很大，關吸塵器時間過長

**建議**:
- 實地測試時記錄所有參數（牆高、地面顏色、超聲波有效範圍）
- 準備 Plan B（例如純超聲波模式，不依賴 IMU）

---

### 2.4 PID 參數調校（中風險）

**當前 PID 參數**:
`config.py: L32-34`
```python
DEFAULT_KP = 0.025  # 比例增益
DEFAULT_KI = 0.002  # 積分增益
DEFAULT_KD = 0.010  # 微分增益
```

**問題**:
- 這組參數是針對「超聲波距離控制」調的
- 如果改成「IMU 航向控制」，需要**重新調參**

**建議調參策略**:
1. **先用純 P 控制**: Kp=0.5, Ki=0, Kd=0
   - 觀察是否震盪
   - 如果震盪，降低 Kp
2. **加入 D 控制**: Kd=0.1
   - 抑制過衝
3. **最後加 I**: Ki=0.01
   - 消除穩態誤差

**預估參數範圍**（航向控制）:
- Kp: 0.3 ~ 1.0（比距離控制大）
- Ki: 0.01 ~ 0.05
- Kd: 0.05 ~ 0.2

---

## 3. 優化建議

### 3.1 混合控制架構（推薦）

結合 IMU 和超聲波的優勢：

```
控制層次架構：

Layer 1: 航向控制（主控）
  - 輸入: IMU Yaw, targetYaw
  - 輸出: angularCorrection (角速度修正)
  - 算法: PID 控制

Layer 2: 距離監督（輔助）
  - 輸入: right_dist, TARGET_RIGHT_DIST
  - 輸出: yawBias (航向偏置)
  - 算法: 慢速積分修正（避免漂移）

Layer 3: 障礙避讓（高優先級）
  - 輸入: front_dist
  - 輸出: 觸發轉彎狀態機
  - 算法: 閾值判斷

融合公式：
angular = Layer1_output + Layer2_bias
if front_dist < 20cm:
    執行 Layer3 轉彎邏輯，暫停 Layer1/2
```

### 3.2 狀態機設計（推薦）

```
狀態圖：

IDLE（待機）
  ↓ CMD_START
ENTER（進場）
  - 直行 2 秒或 50cm
  ↓
TURN_TO_START（轉向起始方向）
  - IMU 左轉 85 度
  - 轉完後：targetYaw = currentYaw（鎖定航向）
  ↓
WALL_FOLLOW（沿牆模式）
  - 航向控制：保持 targetYaw ± 2 度
  - 距離監督：right_dist = 15 ± 5 cm
  - 障礙偵測：front_dist < 20cm → 觸發 TURN_CORNER
  ↓
TURN_CORNER（轉彎）
  - IMU 左轉 85 度
  - cornerCount++
  - 轉完後：targetYaw = currentYaw（重置航向基準）
  ↓ 如果 cornerCount < 4
WALL_FOLLOW（繼續沿牆）
  ↓ 如果 cornerCount >= 4
DONE（完成）
```

### 3.3 參數建議

#### IMU 航向控制 PID（建議值）
```python
# 航向控制 PID（單位：度）
YAW_KP = 0.5    # 1 度偏差 → 0.5 rad/s 角速度
YAW_KI = 0.02   # 累積誤差修正
YAW_KD = 0.1    # 抑制震盪
```

#### 超聲波監督參數（建議值）
```python
# 距離監督（慢速修正 IMU 漂移）
DIST_BIAS_RATE = 0.5  # 度/秒（right_dist 偏離 10cm 時的修正速率）
DIST_DEADZONE = 5     # cm（±5cm 內不修正）
```

#### 轉彎參數（保持不變）
```python
CORNER_TURN_ANGLE = 85   # 度（已測試）
TURN_ANGULAR_SPEED = 0.4 # 轉彎角速度（已測試）
```

---

## 4. 實現步驟建議

### Phase 1: IMU 航向控制基礎（優先）
1. 修改 `wall_follower.cpp`
   - 新增 `_targetYaw`, `_yawLocked` 狀態變數
   - 在 `update()` 中加入航向 PID 控制
   - 保留原有超聲波障礙偵測

2. 測試航向鎖定
   - 場地中央直行 3 米，觀察軌跡是否直線
   - 記錄 Yaw 漂移率（度/分鐘）

### Phase 2: 混合控制（推薦）
3. 加入超聲波監督
   - 慢速修正 targetYaw（避免 IMU 漂移）
   - 只在直行時啟用，轉彎時禁用

4. 測試沿牆行駛
   - 沿牆直行 5 米，觀察距離穩定性
   - 調整 `YAW_KP` 和 `DIST_BIAS_RATE` 平衡

### Phase 3: 入口與完成邏輯
5. 實現進場狀態機
   - 加入 `ENTER` 和 `TURN_TO_START` 狀態
   - 測試從場外進入並轉向

6. 實現角落計數停止
   - `cornerCount >= 4` 時自動停止
   - 加入時間保護（例如 5 分鐘強制停止）

### Phase 4: 整合測試
7. 完整場地測試
   - 測試 10 次，記錄成功率、覆蓋率
   - 調整參數直到穩定

8. 紅色區域測試
   - 測試紅色迴避（關吸塵器）
   - 測試重開吸塵器延遲

---

## 5. 風險評估總表

| 項目 | 風險等級 | 緩解措施 |
|------|----------|----------|
| IMU 長期漂移 | 高 | 每次轉彎重置 targetYaw + 超聲波監督修正 |
| 超聲波噪音 | 中 | 中值濾波 + 連續性檢查 |
| PID 參數不當 | 中 | 分階段調參（先 P，再 D，後 I） |
| 場地特性未知 | 高 | 實地測試 + 備用策略（純超聲波模式） |
| 無限繞圈 | 低 | 角落計數停止 + 時間保護 |
| 紅色誤判 | 低 | 面積閾值 + 延遲確認 |

---

## 6. 最終結論

### 方案可行性：✅ 可行，但需關鍵修正

#### 用戶方案的正確部分
1. ✅ 使用 IMU 做航向控制（比超聲波更適合）
2. ✅ 超聲波只負責障礙偵測（發揮其優勢）
3. ✅ 紅色只關吸塵器（已實現，策略合理）
4. ✅ 入口寫死進場邏輯（必要的簡化）
5. ✅ 實時判斷而非寫死路徑（適應性強）

#### 必須加入的補充
1. ⚠️ **IMU 漂移修正** - 定期重置航向 + 超聲波監督
2. ⚠️ **停止條件** - 角落計數或時間保護
3. ⚠️ **PID 重新調參** - 航向控制參數與距離控制不同
4. ⚠️ **實地測試驗證** - 場地特性影響策略有效性

### 推薦實現方案

**混合控制架構**（結合 IMU 和超聲波優勢）：
- **主控**: IMU 航向鎖定（保持直線，50Hz 高頻）
- **監督**: 超聲波距離修正（慢速修正 IMU 漂移，10Hz 低頻）
- **高優**: 前方障礙偵測（觸發轉彎，事件驅動）

**狀態機流程**：
```
IDLE → ENTER（進場 2s） → TURN_TO_START（轉 85°） →
WALL_FOLLOW（沿牆，航向鎖定） ⇄ TURN_CORNER（轉彎，重置航向） →
DONE（4 個角落或超時）
```

### 成功關鍵因素
1. **IMU 校準**: 開機時靜止校準，消除陀螺儀零漂
2. **航向重置**: 每次轉彎後重置基準，避免漂移累積
3. **參數調優**: 實地測試調整 PID 參數
4. **備用策略**: 如果 IMU 失效，能切換回純超聲波模式

### 預期效果
- 直行軌跡：震盪 ±2cm（IMU 控制）vs ±10cm（Bang-Bang）
- 角落精度：±3 度（IMU 輔助）
- 完成時間：減少 20%（減少震盪 = 路徑更短）

---

## 附錄：相關代碼位置

- **IMU 讀取**: `/home/han/claude_project/mechtronic_4/v2_autonomous/arduino/main/mpu6050_sensor.cpp`
- **沿牆控制**: `/home/han/claude_project/mechtronic_4/v2_autonomous/arduino/main/wall_follower.cpp`
- **Pi 控制器**: `/home/han/claude_project/mechtronic_4/v2_autonomous/raspberry_pi/controller.py`
- **參數配置**: `/home/han/claude_project/mechtronic_4/v2_autonomous/raspberry_pi/config.py`
- **協定定義**: `/home/han/claude_project/mechtronic_4/v2_autonomous/raspberry_pi/protocol.py`

---

**報告結束**

如有任何疑問或需要進一步分析，請隨時提出。
