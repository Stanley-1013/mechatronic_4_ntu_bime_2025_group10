# V3 自走吸塵車 - 軟體需求規格書 (SRS)

**版本**: 1.0
**日期**: 2025-12-06
**專案代號**: V3-Stable

---

## 1. 簡介

### 1.1 目的

本文件定義 V3 自走吸塵車系統的軟體需求，作為系統分析、設計與測試的依據。

### 1.2 專案背景

基於 V1/V2 的開發經驗，V3 的核心目標是**穩定性優先**：
- V1 問題：超聲波阻塞 Serial、無自走功能
- V2 問題：EMI 干擾導致重置、PID 調參困難、架構複雜度高

V3 設計原則：
1. **簡化架構** - 減少通訊負擔與故障點
2. **Arduino 自主控制** - 避免通訊延遲影響即時控制
3. **保守參數** - 低速穩定優先於高速完成

### 1.3 範圍

本系統包含：
- Arduino 底層控制（馬達、感測器、沿牆邏輯）
- Raspberry Pi 視覺處理（紅色偵測）
- 雙控制器通訊協定

不包含：
- 路徑規劃演算法（固定沿右牆策略）
- 地圖建置（無 SLAM）
- 遙控功能（純自走模式）

---

## 2. 系統概述

### 2.1 系統架構

```
┌─────────────────────────────┐
│     Raspberry Pi 4          │
│  ┌───────────────────────┐  │
│  │ 紅色偵測模組           │  │
│  │ (Pi Camera + OpenCV)  │  │
│  └───────────┬───────────┘  │
│              │ 紅色事件      │
│  ┌───────────▼───────────┐  │
│  │ 通訊模組              │  │
│  │ (Serial 115200)       │  │
│  └───────────┬───────────┘  │
└──────────────┼──────────────┘
               │ 單向：Pi → Arduino
               │ (僅紅色迴避指令)
               ▼
┌──────────────────────────────┐
│       Arduino Uno            │
│  ┌────────────────────────┐  │
│  │ 主控制迴圈 (50Hz)      │  │
│  │ - 超聲波讀取           │  │
│  │ - 沿牆控制             │  │
│  │ - 馬達輸出             │  │
│  └────────────────────────┘  │
└──────────────────────────────┘
```

### 2.2 運作流程

```
場外起點 (車頭朝場內)
    │
    ▼
[進場] 直走進入場地
    │
    ▼
[找牆] 右轉直到找到右牆
    │
    ▼
[沿牆] 沿右牆逆時針繞行 ←────┐
    │                        │
    ├─ 遇紅色 → 關吸塵器 ────┤
    │                        │
    ├─ 遇角落 → 左轉 90° ────┤
    │                        │
    └─ 完成 4 角落 ──────────┘
    │
    ▼
[出場] 偵測到出口（右側無牆）→ 直走出場
    │
    ▼
[停止] 任務完成
```

---

## 3. 功能需求

### 3.1 沿牆行駛 (FR-001)

| 項目 | 規格 |
|------|------|
| **需求 ID** | FR-001 |
| **優先級** | 必要 (Must) |
| **描述** | 系統應沿右側牆壁行駛，維持固定距離 |

**詳細規格**：

| 參數 | 數值 | 說明 |
|------|------|------|
| 目標距離 | 15 cm | 右側超聲波到牆壁 |
| 容許誤差 | ±5 cm | 10~20 cm 視為正常 |
| 行駛速度 | PWM 60 | 約 20% 動力，穩定優先 |
| 控制頻率 | 20 Hz | 每 50ms 更新一次 |

**控制策略**：

採用**比例控制 (P-Control)** 搭配**輸出限幅**：

```
error = 目標距離 - 實際距離
angular = Kp * error
angular = clamp(angular, -MAX_ANGULAR, +MAX_ANGULAR)

左輪 PWM = BASE_PWM * (1 - angular)
右輪 PWM = BASE_PWM * (1 + angular)
```

| 參數 | 數值 | 說明 |
|------|------|------|
| Kp | 0.02 | 比例增益（保守值） |
| MAX_ANGULAR | 0.3 | 最大轉向幅度 |
| BASE_PWM | 60 | 基礎速度 |

**為何選擇 P-Control**：
- 比 Bang-Bang 平滑，減少震盪
- 比 PID 簡單，無積分飽和問題
- 低速場景下 P-Control 已足夠

---

### 3.2 角落轉彎 (FR-002)

| 項目 | 規格 |
|------|------|
| **需求 ID** | FR-002 |
| **優先級** | 必要 (Must) |
| **描述** | 偵測前方障礙時執行左轉 90° |

**觸發條件**：
- 前方距離 < 25 cm（進入角落區）
- 前方距離 < 20 cm（停止前進，純轉向）

**轉彎策略**：

採用**開環定時轉向**（不依賴 IMU）：

```
當 front_dist < 20cm:
    左輪後退 PWM = -60
    右輪前進 PWM = +60
    持續 800ms（約轉 90°）
    恢復沿牆模式
```

**為何不用 IMU 閉環**：
- MPU6050 積分漂移 ~0.77°/分鐘
- 角落轉彎時間短（<1秒），漂移影響小
- 開環更簡單可靠，失敗後可由沿牆邏輯自動修正

**角落計數**：
- 每次觸發轉彎時 `cornerCount++`
- 完成 4 次角落後進入出場模式

---

### 3.3 紅色區域迴避 (FR-003)

| 項目 | 規格 |
|------|------|
| **需求 ID** | FR-003 |
| **優先級** | 必要 (Must) |
| **描述** | 偵測到紅色區域時關閉吸塵器 |

**偵測規格**：

| 參數 | 數值 |
|------|------|
| 影像來源 | Pi Camera (320×240) |
| 處理頻率 | 10 FPS |
| 顏色空間 | HSV |
| 紅色範圍 | H: 0-10, 160-180 |
| 最小面積 | 1000 pixels |

**迴避策略**：

採用**策略 A：關閉吸塵器 + 繼續沿牆**

```
偵測到紅色:
    → Pi 發送 VACUUM_OFF 指令
    → Arduino 關閉吸塵器繼電器
    → 繼續沿牆行駛（不改變路徑）

紅色消失（連續 1 秒無偵測）:
    → Pi 發送 VACUUM_ON 指令
    → Arduino 開啟吸塵器
```

**為何不選轉向迴避**：
- 轉向可能導致偏離牆壁，需重新尋牆
- 關吸塵器策略更簡單，路徑不受影響
- 穩定性優先於清掃覆蓋率

---

### 3.4 出場行駛 (FR-004)

| 項目 | 規格 |
|------|------|
| **需求 ID** | FR-004 |
| **優先級** | 必要 (Must) |
| **描述** | 完成 4 個角落後偵測出口並駛出場地 |

**出場邏輯**：

```
條件: cornerCount >= 4

出口偵測:
    當 right_dist > 50cm (右側無牆，即出口)
    且持續 300ms (避免誤判)

出場動作:
    1. 右轉 45° 朝向出口
    2. 直走 2 秒
    3. 停止，任務完成
```

**場地示意**：
```
    ┌─────────────────────┐
    │                     │
    │   ← 逆時針繞行      │
    │                     │
    │                     │
    │                     │
    └────────┬────────────┘
             │ ← 出口（起點位置）
           [車]
```

**關鍵假設**：
- 起點即為出口位置
- 完成 4 角落後，車輛會回到起點附近
- 右側超聲波偵測到「無牆」即為出口

---

### 3.5 吸塵器控制 (FR-005)

| 項目 | 規格 |
|------|------|
| **需求 ID** | FR-005 |
| **優先級** | 必要 (Must) |
| **描述** | 控制吸塵器繼電器開關 |

**控制邏輯**：

| 狀態 | 吸塵器 |
|------|--------|
| 正常沿牆 | 開啟 |
| 角落轉彎中 | 開啟 |
| 紅色區域 | 關閉 |
| 出場中 | 關閉 |
| 系統停止 | 關閉 |

---

### 3.6 任務結束判斷 (FR-006)

| 項目 | 規格 |
|------|------|
| **需求 ID** | FR-006 |
| **優先級** | 必要 (Must) |
| **描述** | 完成場地清掃並出場後自動停止 |

**結束條件**（任一）：
1. 正常結束：完成出場動作
2. 安全超時：運行時間超過 5 分鐘

**停止動作**：
1. 馬達停止
2. 吸塵器關閉
3. 系統進入待機狀態

---

## 4. 非功能需求

### 4.1 穩定性 (NFR-001)

| 項目 | 規格 |
|------|------|
| **需求 ID** | NFR-001 |
| **優先級** | 最高 |
| **描述** | 系統應能穩定完成單圈清掃並出場 |

**量化指標**：
- 連續 10 次測試，成功率 ≥ 90%
- 無 EMI 導致的系統重置
- 無通訊失敗導致的停滯

### 4.2 即時性 (NFR-002)

| 項目 | 規格 |
|------|------|
| **需求 ID** | NFR-002 |
| **優先級** | 高 |
| **描述** | 控制迴圈應維持穩定頻率 |

**量化指標**：
- Arduino 主迴圈：50Hz ± 5%
- 超聲波讀取延遲：< 10ms
- 紅色偵測延遲：< 200ms

### 4.3 安全性 (NFR-003)

| 項目 | 規格 |
|------|------|
| **需求 ID** | NFR-003 |
| **優先級** | 高 |
| **描述** | 系統異常時應安全停止 |

**保護機制**：
- Watchdog Timer：2 秒無回應則重置
- 通訊超時：500ms 無指令則維持當前狀態
- 感測器失效：前方距離 < 10cm 且持續 2 秒則停止

---

## 5. 硬體約束

### 5.1 感測器特性

| 感測器 | 更新率 | 有效範圍 | 限制 |
|--------|--------|----------|------|
| 前方超聲波 | 10 Hz | 2-400 cm | 延遲 ~100ms |
| 右側超聲波 | 10 Hz | 2-400 cm | 易受干擾 |
| Pi Camera | 30 FPS | - | 處理後 10 FPS |

### 5.2 馬達特性

| 參數 | 數值 |
|------|------|
| 驅動器 | L298N |
| 最小有效 PWM | 45 |
| 建議工作 PWM | 60-120 |
| 左右差異 | 需校正 (~5%) |

### 5.3 通訊限制

| 參數 | 數值 |
|------|------|
| 介面 | Serial (UART) |
| 鮑率 | 115200 |
| 最大封包大小 | 16 bytes |
| 建議頻率 | ≤ 10 Hz（減少負擔） |

---

## 6. 介面需求

### 6.1 Pi → Arduino 通訊

僅需兩種指令：

| 指令 | 代碼 | 說明 |
|------|------|------|
| VACUUM_ON | 0x01 | 開啟吸塵器 |
| VACUUM_OFF | 0x02 | 關閉吸塵器 |

封包格式（極簡化）：
```
[Header: 0xAA][Command: 1 byte][Checksum][Footer: 0x55]
```

### 6.2 Arduino → Pi 通訊

**不需要**。Arduino 自主控制，不回報狀態。

減少通訊的理由：
- 降低 Serial 緩衝區壓力
- 避免 TX 阻塞影響控制迴圈
- Pi 只需知道紅色偵測結果，無需實時狀態

---

## 7. 設計約束

### 7.1 從 V2 學到的教訓

| 問題 | V3 對策 |
|------|---------|
| EMI 導致重置 | 啟動時延遲 3 秒；Watchdog 保護 |
| PID 調參困難 | 改用簡單 P-Control |
| 通訊負擔重 | 極簡協定，僅吸塵器控制 |
| 狀態機複雜 | 連續控制 + 簡單模式切換 |
| 超聲波阻塞 | 交替讀取 + 超時保護 |

### 7.2 開發優先級

1. **Phase 1**: 基礎沿牆（無紅色偵測）
2. **Phase 2**: 加入角落轉彎
3. **Phase 3**: 加入出場邏輯
4. **Phase 4**: 整合紅色偵測
5. **Phase 5**: 調參與穩定性測試

---

## 8. 驗收標準

### 8.1 功能驗收

| 測試項目 | 通過標準 |
|----------|----------|
| 沿牆行駛 | 維持 10-20cm 距離，無明顯震盪 |
| 角落轉彎 | 4 個角落均成功轉彎 |
| 紅色迴避 | 經過紅色區域時吸塵器關閉 |
| 出場 | 偵測出口後成功駛出場地 |
| 任務結束 | 出場後自動停止 |

### 8.2 穩定性驗收

| 測試項目 | 通過標準 |
|----------|----------|
| 連續測試 | 10 次測試成功 ≥ 9 次 |
| 長時間運行 | 5 分鐘內無當機 |
| EMI 耐受 | 馬達啟停不導致重置 |

---

## 附錄 A：術語表

| 術語 | 定義 |
|------|------|
| 沿牆 | 保持與右側牆壁固定距離行駛 |
| 角落 | 前方與右側同時偵測到牆壁的區域 |
| 出口 | 場地邊界缺口，右側無牆的位置 |
| EMI | 電磁干擾，馬達產生的雜訊 |
| PWM | 脈衝寬度調變，控制馬達速度 |

## 附錄 B：修訂歷史

| 版本 | 日期 | 作者 | 變更說明 |
|------|------|------|----------|
| 1.0 | 2025-12-06 | Claude | 初版，基於 V1/V2 經驗 |
