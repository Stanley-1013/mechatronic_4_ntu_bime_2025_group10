# V3 自走吸塵車 - 測試設計文件 (TDD)

**版本**: 1.0
**日期**: 2025-12-06
**關聯文件**: 01_SRS, 02_SA, 03_SD, 04_ICD

---

## 1. 測試策略

### 1.1 測試層級

```
┌─────────────────────────────────────────────────────────┐
│                    驗收測試 (AT)                        │
│               完整場地測試、連續穩定性測試                 │
├─────────────────────────────────────────────────────────┤
│                    整合測試 (IT)                        │
│           沿牆控制、角落轉彎、紅色偵測整合                  │
├─────────────────────────────────────────────────────────┤
│                    單元測試 (UT)                        │
│         超聲波濾波、行為計算、PWM 輸出、通訊封包            │
└─────────────────────────────────────────────────────────┘
```

### 1.2 測試環境

| 環境 | 說明 |
|------|------|
| 桌上測試 | 車輪架空，用手遮擋感測器模擬 |
| 走廊測試 | 直線沿牆測試 (無角落) |
| 角落測試 | L 型牆壁測試 |
| 完整場地 | 300×300 cm 比賽場地 |

---

## 2. 單元測試

### 2.1 超聲波濾波測試 (UT-001)

**測試目標**: 驗證中值濾波正確濾除雜訊

**測試方法**:
```cpp
// 測試程式碼
void test_ultrasonic_filter() {
    Ultrasonic us;
    us.init(7, 8);

    // 模擬輸入序列
    int inputs[] = {15, 15, 100, 15, 15};  // 100 是雜訊
    int expected = 15;  // 中位數應該是 15

    for (int i = 0; i < 5; i++) {
        // 手動設定歷史值 (需要在 class 中加 test hook)
        us._history[i % 3] = inputs[i];
    }

    int result = us.getFiltered();
    assert(result == expected);
}
```

**通過標準**:
| 輸入序列 | 預期輸出 |
|----------|----------|
| [15, 15, 15] | 15 |
| [10, 15, 20] | 15 |
| [15, 100, 15] | 15 |
| [5, 10, 15] | 10 |

---

### 2.2 沿牆行為測試 (UT-002)

**測試目標**: 驗證 P-Control 輸出正確

**測試方法**:
```cpp
void test_wall_behavior() {
    BehaviorController bc;
    bc.init();

    // 測試不同距離
    struct TestCase {
        int rightDist;
        float expectedAngular;
    } cases[] = {
        {15, 0.0},      // 正好在目標距離
        {10, 0.1},      // 太近，右轉 (positive angular)
        {20, -0.1},     // 太遠，左轉 (negative angular)
        {5, 0.2},       // 很近
        {25, -0.2},     // 很遠
    };

    for (auto& tc : cases) {
        BehaviorOutput out = bc._wallBehavior(tc.rightDist);
        assert(abs(out.angular - tc.expectedAngular) < 0.01);
    }
}
```

**通過標準**:
| right_dist | error | 預期 angular |
|------------|-------|--------------|
| 15 cm | 0 | 0.0 |
| 10 cm | +5 | +0.1 |
| 20 cm | -5 | -0.1 |
| 5 cm | +10 | +0.2 |
| 25 cm | -10 | -0.2 |

---

### 2.3 避障行為測試 (UT-003)

**測試目標**: 驗證避障權重曲線正確

**測試方法**:
```cpp
void test_avoid_behavior() {
    BehaviorController bc;
    bc.init();

    struct TestCase {
        int frontDist;
        float expectedWeight;
    } cases[] = {
        {50, 0.0},       // 遠處，不參與
        {40, 0.0},       // 邊界
        {30, 0.4},       // 中間
        {20, 0.8},       // 接近
        {15, 1.0},       // 完全避障
        {10, 1.0},       // 很近
    };

    for (auto& tc : cases) {
        BehaviorOutput out = bc._avoidBehavior(tc.frontDist);
        assert(abs(out.weight - tc.expectedWeight) < 0.1);
    }
}
```

**通過標準**:
| front_dist | 預期 weight | 預期 angular |
|------------|-------------|--------------|
| > 40 cm | 0.0 | 0 |
| 40 cm | 0.0 | 0 |
| 30 cm | ~0.4 | 0.5 |
| 20 cm | ~0.8 | 0.5 |
| ≤ 20 cm | 1.0 | 0.5 |

---

### 2.4 行為融合測試 (UT-004)

**測試目標**: 驗證權重正規化和加權混合正確

**測試方法**:
```cpp
void test_behavior_blend() {
    // 場景 1: 純沿牆
    // wall.weight=1.0, avoid.weight=0.0
    // angular = 1.0 * wall.angular + 0.0 * 0.5 = wall.angular

    // 場景 2: 50% 避障
    // wall.weight=1.0, avoid.weight=1.0
    // 正規化後: wall=0.5, avoid=0.5
    // angular = 0.5 * wall.angular + 0.5 * 0.5

    // 場景 3: 完全避障
    // wall.weight=1.0, avoid.weight=很大
    // angular ≈ avoid.angular = 0.5
}
```

**通過標準**:
| wall_w | wall_a | avoid_w | avoid_a | 預期融合 angular |
|--------|--------|---------|---------|------------------|
| 1.0 | 0.0 | 0.0 | 0.5 | 0.0 |
| 1.0 | 0.1 | 0.0 | 0.5 | 0.1 |
| 1.0 | 0.0 | 1.0 | 0.5 | 0.25 |
| 1.0 | -0.1 | 1.0 | 0.5 | 0.2 |
| 0.0 | 0.0 | 1.0 | 0.5 | 0.5 |

---

### 2.5 馬達 PWM 計算測試 (UT-005)

**測試目標**: 驗證 angular → PWM 轉換正確

**測試方法**:
```cpp
void test_motor_pwm() {
    // angular = 0 → left = right = 60
    // angular = +0.5 → left = 60*(1-0.5)=30, right = 60*(1+0.5)=90
    // angular = -0.3 → left = 60*(1+0.3)=78, right = 60*(1-0.3)=42

    struct TestCase {
        float angular;
        int expectedLeft;
        int expectedRight;
    } cases[] = {
        {0.0, 60, 60},
        {0.5, 30, 90},
        {-0.3, 78, 42},
        {0.3, 42, 78},
    };
}
```

**通過標準**:
| angular | left_pwm | right_pwm |
|---------|----------|-----------|
| 0.0 | 60 | 60 |
| +0.3 | 42 | 78 |
| -0.3 | 78 | 42 |
| +0.5 | 30 | 90 |

---

### 2.6 Serial 封包解析測試 (UT-006)

**測試目標**: 驗證封包解析正確，錯誤封包被丟棄

**測試方法**:
```cpp
void test_serial_parse() {
    SerialCommand sc;
    sc.init(115200);

    // 正確封包
    byte valid[] = {0xAA, 0x01, 0xAB, 0x55};
    for (int i = 0; i < 4; i++) {
        // 模擬 Serial.read()
        sc._processChar(valid[i]);
    }
    assert(sc.getCommand() == 0x01);

    // 錯誤 Checksum
    byte invalid[] = {0xAA, 0x01, 0x00, 0x55};
    for (int i = 0; i < 4; i++) {
        sc._processChar(invalid[i]);
    }
    assert(sc.getCommand() != 0x01);  // 應該被丟棄
}
```

**通過標準**:
| 封包 | 預期結果 |
|------|----------|
| [0xAA, 0x01, 0xAB, 0x55] | 指令 0x01 |
| [0xAA, 0x02, 0xA8, 0x55] | 指令 0x02 |
| [0xAA, 0x01, 0x00, 0x55] | 丟棄 (Checksum 錯) |
| [0x00, 0x01, 0xAB, 0x55] | 丟棄 (Header 錯) |

---

## 3. 整合測試

### 3.1 直線沿牆測試 (IT-001)

**測試目標**: 驗證車輛能沿直牆行駛

**測試環境**: 走廊或直牆 (長度 ≥ 2m)

**測試步驟**:
1. 將車輛放置於距牆 15cm 處
2. 啟動系統
3. 觀察行駛軌跡

**通過標準**:
- [ ] 車輛保持 10-20cm 距離
- [ ] 無明顯震盪 (左右擺幅 < 5cm)
- [ ] 行駛 2m 後仍在範圍內

**紀錄表**:
| 起始距離 | 1m 處距離 | 2m 處距離 | 結果 |
|----------|-----------|-----------|------|
| 15 cm | | | |
| 10 cm | | | |
| 20 cm | | | |

---

### 3.2 單角落轉彎測試 (IT-002)

**測試目標**: 驗證車輛能在角落成功左轉

**測試環境**: L 型牆壁 (90° 角落)

**測試步驟**:
1. 將車輛放置於沿牆行駛中
2. 讓車輛行駛至角落
3. 觀察轉彎行為

**通過標準**:
- [ ] 偵測到前方障礙 (front_dist < 20cm)
- [ ] 成功左轉約 90°
- [ ] 轉彎後恢復沿牆行駛
- [ ] cornerCount 增加 1

**紀錄表**:
| 測試次數 | 轉彎成功 | 轉彎後距離 | 備註 |
|----------|----------|------------|------|
| 1 | | | |
| 2 | | | |
| 3 | | | |

---

### 3.3 出場偵測測試 (IT-003)

**測試目標**: 驗證完成 4 角落後能偵測出口

**測試環境**: 模擬場地 (含出口缺口)

**測試步驟**:
1. 手動設定 cornerCount = 4
2. 讓車輛沿牆行駛經過出口
3. 觀察出場行為

**通過標準**:
- [ ] 偵測到右側無牆 (right_dist > 50cm)
- [ ] 觸發出場行為
- [ ] 正確右轉後直走
- [ ] 最終停止

---

### 3.4 紅色偵測整合測試 (IT-004)

**測試目標**: 驗證紅色偵測與吸塵器控制整合

**測試環境**: 有紅色區域的場地

**測試步驟**:
1. 在路徑上放置紅色區域
2. 啟動系統
3. 觀察通過紅色區域時的行為

**通過標準**:
- [ ] 偵測到紅色時吸塵器關閉
- [ ] 離開紅色區域 1 秒後吸塵器開啟
- [ ] 行駛路徑不受影響

---

## 4. 驗收測試

### 4.1 完整單圈測試 (AT-001)

**測試目標**: 驗證完整比賽流程

**測試環境**: 300×300 cm 比賽場地

**測試步驟**:
1. 將車輛放置於起點 (場外)
2. 啟動系統
3. 記錄完成時間和結果

**通過標準**:
- [ ] 成功進場
- [ ] 沿牆繞行 4 個角落
- [ ] 成功出場
- [ ] 總時間 < 3 分鐘
- [ ] 無碰撞牆壁

**紀錄表**:
| 測試次數 | 完成時間 | 結果 | 備註 |
|----------|----------|------|------|
| 1 | | | |
| 2 | | | |
| 3 | | | |

---

### 4.2 紅色區域閃避測試 (AT-002)

**測試目標**: 驗證紅色區域處理

**測試環境**: 比賽場地 + 紅色區域

**測試步驟**:
1. 在路徑上放置 1-2 個紅色區域
2. 執行完整單圈測試
3. 觀察紅色區域處理

**通過標準**:
- [ ] 經過紅色區域時吸塵器關閉
- [ ] 完成繞行後出場
- [ ] 未吸入紅色區域

---

### 4.3 連續穩定性測試 (AT-003)

**測試目標**: 驗證系統穩定性

**測試環境**: 比賽場地

**測試步驟**:
1. 連續執行 10 次完整測試
2. 記錄每次結果

**通過標準**:
- [ ] 成功率 ≥ 90% (9/10 次成功)
- [ ] 無 EMI 導致的重置
- [ ] 無通訊失敗

**紀錄表**:
| 次數 | 結果 | 失敗原因 (如有) |
|------|------|-----------------|
| 1 | | |
| 2 | | |
| 3 | | |
| 4 | | |
| 5 | | |
| 6 | | |
| 7 | | |
| 8 | | |
| 9 | | |
| 10 | | |

**統計**:
- 成功次數: ___/10
- 成功率: ___%

---

## 5. 問題追蹤

### 5.1 常見問題與解決方案

| 問題 | 可能原因 | 解決方案 |
|------|----------|----------|
| 沿牆震盪 | Kp 太大 | 降低 KP_WALL 至 0.015 |
| 轉彎不足 | 轉彎時間太短 | 增加 避障持續時間 |
| 轉彎過度 | 轉彎時間太長 | 減少 避障持續時間 |
| 偏左行駛 | 左輪較強 | 降低 LEFT_SCALE |
| 偏右行駛 | 右輪較強 | 降低 RIGHT_SCALE |
| 不偵測紅色 | HSV 範圍不對 | 調整 RED_LOWER/UPPER |
| 誤偵測紅色 | 面積閾值太低 | 提高 MIN_RED_AREA |

### 5.2 問題紀錄模板

```
問題編號: BUG-XXX
發現日期: YYYY-MM-DD
測試項目: AT-001
問題描述: _______________
重現步驟: _______________
預期行為: _______________
實際行為: _______________
根本原因: _______________
解決方案: _______________
驗證結果: _______________
```

---

## 6. 測試檢查清單

### 6.1 測試前檢查

- [ ] Arduino 程式碼已上傳
- [ ] Pi 程式碼已部署
- [ ] Serial 連接正常
- [ ] 電池充滿
- [ ] 場地乾淨無障礙物

### 6.2 測試後檢查

- [ ] 記錄測試結果
- [ ] 分析失敗原因 (如有)
- [ ] 更新問題追蹤
- [ ] 備份測試影片/照片

---

## 附錄 A：測試結果範本

### 單元測試結果

| 測試 ID | 測試名稱 | 結果 | 備註 |
|---------|----------|------|------|
| UT-001 | 超聲波濾波 | | |
| UT-002 | 沿牆行為 | | |
| UT-003 | 避障行為 | | |
| UT-004 | 行為融合 | | |
| UT-005 | PWM 計算 | | |
| UT-006 | Serial 解析 | | |

### 整合測試結果

| 測試 ID | 測試名稱 | 結果 | 備註 |
|---------|----------|------|------|
| IT-001 | 直線沿牆 | | |
| IT-002 | 單角落轉彎 | | |
| IT-003 | 出場偵測 | | |
| IT-004 | 紅色整合 | | |

### 驗收測試結果

| 測試 ID | 測試名稱 | 結果 | 備註 |
|---------|----------|------|------|
| AT-001 | 完整單圈 | | |
| AT-002 | 紅色閃避 | | |
| AT-003 | 連續穩定 | | |

---

## 附錄 B：修訂歷史

| 版本 | 日期 | 變更說明 |
|------|------|----------|
| 1.0 | 2025-12-06 | 初版 |
