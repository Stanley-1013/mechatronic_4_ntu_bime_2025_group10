# V3 自走吸塵車 - 系統分析 (SA)

**版本**: 1.0
**日期**: 2025-12-06
**關聯文件**: 01_SRS_軟體需求規格.md

---

## 1. 系統分解

### 1.1 子系統架構

```
┌─────────────────────────────────────────────────────────────┐
│                    V3 自走吸塵車系統                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────┐    ┌─────────────────────────────┐ │
│  │   視覺子系統 (Pi)    │    │     控制子系統 (Arduino)     │ │
│  │                     │    │                             │ │
│  │  ┌───────────────┐  │    │  ┌─────────────────────┐   │ │
│  │  │ 影像擷取模組   │  │    │  │ 感測器讀取模組       │   │ │
│  │  └───────┬───────┘  │    │  │ - 前方超聲波        │   │ │
│  │          │          │    │  │ - 右側超聲波        │   │ │
│  │  ┌───────▼───────┐  │    │  └─────────┬───────────┘   │ │
│  │  │ 紅色偵測模組   │  │    │            │               │ │
│  │  └───────┬───────┘  │    │  ┌─────────▼───────────┐   │ │
│  │          │          │    │  │ 行為融合控制模組     │   │ │
│  │  ┌───────▼───────┐  │    │  │ - 轉彎行為 (優先)   │   │ │
│  │  │ 通訊模組      │──┼────┼─▶│ - 出場行為 (優先)   │   │ │
│  │  └───────────────┘  │    │  │ - 沿牆+避障 (融合)  │   │ │
│  │                     │    │  └─────────┬───────────┘   │ │
│  │                     │    │            │               │ │
│  │                     │    │  ┌─────────▼───────────┐   │ │
│  │                     │    │  │ 馬達驅動模組         │   │ │
│  │                     │    │  └─────────┬───────────┘   │ │
│  │                     │    │            │               │ │
│  │                     │    │  ┌─────────▼───────────┐   │ │
│  │                     │    │  │ 吸塵器控制模組       │   │ │
│  │                     │    │  └─────────────────────┘   │ │
│  │                     │    │                             │ │
│  └─────────────────────┘    └─────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 模組責任分配

| 模組 | 所在平台 | 責任 | 更新頻率 |
|------|----------|------|----------|
| 影像擷取 | Pi | 讀取 Camera 影像 | 30 FPS |
| 紅色偵測 | Pi | HSV 色彩分析 | 10 FPS |
| 通訊 | Pi | 發送吸塵器控制指令 | 事件驅動 |
| 感測器讀取 | Arduino | 超聲波測距 | 20 Hz |
| 行為融合控制 | Arduino | 連續控制輸出 | 20 Hz |
| 馬達驅動 | Arduino | PWM 輸出 | 20 Hz |
| 吸塵器控制 | Arduino | 繼電器開關 | 事件驅動 |

**設計原則**：Pi 端極簡化，僅負責紅色偵測與吸塵器控制。

---

## 2. 連續控制架構（無狀態機）

### 2.1 設計理念

**不使用狀態機**，改用**行為融合 (Behavior Blending)** 架構：

- 每個控制週期同時計算多個「行為」的輸出
- 根據當前感測器值動態計算各行為的權重
- 加權混合得到最終馬達輸出
- 沒有離散的模式切換，只有連續的權重變化

```
感測器輸入
    │
    ├──▶ 行為1: 沿牆 ──────┐
    │                      │
    ├──▶ 行為2: 避障 ──────┼──▶ 權重混合 ──▶ 馬達輸出
    │                      │
    └──▶ 行為3: 出場 ──────┘
```

### 2.2 三個行為定義

#### 行為 1：沿牆行為 (Wall Following)

**目的**：維持與右牆固定距離

**輸入**：right_dist (右側距離)
**輸出**：angular_wall (轉向量)

```
error = TARGET_DIST - right_dist    // 15 - right_dist
angular_wall = Kp * error           // 0.02 * error
angular_wall = clamp(angular_wall, -0.3, +0.3)
```

**權重計算**：
```
wall_weight = 1.0  // 基礎權重，永遠參與
```

#### 行為 2：避障行為 (Obstacle Avoidance) - **行為覆蓋模式**

**目的**：前方有障礙時執行原地左轉

**輸入**：front_dist (前方距離)
**輸出**：left_pwm, right_pwm (直接覆蓋，非加權)

**關鍵修正**：當 front_dist < STOP_DIST 時，**完全覆蓋其他行為**，執行原地轉彎

```
if front_dist < STOP_DIST:          // 20cm - 原地左轉（覆蓋模式）
    left_pwm = -TURN_PWM            // -60 (後退)
    right_pwm = +TURN_PWM           // +60 (前進)
    is_turning = true

elif front_dist < SLOW_DIST:        // 40cm - 減速左偏（融合模式）
    angular_avoid = +0.3            // 溫和左轉
    avoid_weight = map(front_dist, STOP_DIST, SLOW_DIST, 0.8, 0.0)
    is_turning = false

else:
    angular_avoid = 0
    avoid_weight = 0.0
    is_turning = false
```

**轉彎完成檢測**（雙條件 + 超時保護 + 穩定期）：
```
// 記錄進入轉彎時的前方距離
if !is_turning && front_dist < FRONT_STOP:
    is_turning = true
    turn_timer = 0
    turn_confirm = 0
    turn_entry_front = front_dist  // 記錄進入時前方距離

if is_turning:
    turn_timer++

    // 超時保護（2 秒，縮短避免等太久）
    if turn_timer > TURN_TIMEOUT:   // 40 cycles = 2 秒
        is_turning = false
        turn_timer = 0
        stable_timer = TURN_STABLE
        cornerCount++
        return

    // 雙條件完成檢測（更可靠）
    // 條件 A: 右側看到新牆 (<30cm)
    // 條件 B: 前方距離增加 (>50cm，表示已離開角落)
    bool rightWallDetected = (right_dist < 30 && right_dist > 5);
    bool frontCleared = (front_dist > 50);

    if (rightWallDetected || frontCleared) {
        turn_confirm++;
    } else {
        turn_confirm = 0;
    }

    if turn_confirm >= 3:   // 連續 150ms 確認
        is_turning = false
        turn_timer = 0
        stable_timer = TURN_STABLE + TURN_FORWARD_MIN  // 穩定期 + 最小前進
        cornerCount++
```

**穩定期**（轉彎後抗抖動 + 強制前進）：
```
// 轉彎完成後強制前進一段距離，避免立即再次觸發
if stable_timer > 0:
    stable_timer--
    // 強制執行沿牆行為，忽略轉彎條件
    return handleWallFollow()
```

**參數**：
```
TURN_TIMEOUT = 40        // 轉彎超時 2 秒（從 3 秒縮短）
TURN_STABLE = 3          // 穩定期 150ms
TURN_FORWARD_MIN = 10    // 轉彎後最小前進 500ms
TURN_COMPLETE_FRONT = 50 // 前方暢通判定距離
```

#### 行為 3：出場行為 (Exit Behavior) - **時間窗口 + 多條件確認**

**目的**：完成繞行後駛出場地

**輸入**：right_dist, front_dist, cornerCount, stable_timer
**輸出**：left_pwm, right_pwm (覆蓋模式)

**關鍵改進**：加入「時間窗口」防止第 4 角剛轉完就誤判

**出場偵測邏輯**：
```
// 第 4 角完成時記錄時間
if cornerCount == 4 && exit_search_start == 0:
    exit_search_start = millis()

// 出場搜尋窗口：第 4 角後 2~15 秒內有效
bool inExitWindow = (cornerCount >= 4) &&
                    (millis() - exit_search_start > EXIT_WINDOW_MIN) &&
                    (millis() - exit_search_start < EXIT_WINDOW_MAX);

// 多條件出口偵測
出口條件 = ALL of:
    1. inExitWindow                 // 在有效時間窗口內
    2. right_dist > 50cm            // 右側無牆
    3. front_dist > 60cm            // 前方暢通
    4. stable_timer == 0            // 不在穩定期（剛轉完彎）
    5. !is_turning                  // 不在轉彎中

if 出口條件:
    exit_counter++
else if exit_counter > 0 && exit_counter < EXIT_CONFIRM:
    exit_counter -= 0.5             // 緩慢衰減抗噪
    if exit_counter < 0: exit_counter = 0
else:
    exit_counter = 0

// 超時保護：窗口內未找到出口 → 停止
if cornerCount >= 4 && millis() - exit_search_start > EXIT_WINDOW_MAX:
    complete = true
```

**出場動作**：
```
if exit_counter >= EXIT_CONFIRM:    // 持續 300ms (6 cycles)
    vacuum.off()                    // 關閉吸塵器

    if exit_counter < EXIT_TURN:    // 前 800ms
        // 階段 1: 右轉 45° 朝向出口
        left_pwm = +TURN_PWM
        right_pwm = -TURN_PWM / 2

    elif exit_counter < EXIT_TOTAL: // 之後 2000ms
        // 階段 2: 直走出場
        left_pwm = BASE_PWM
        right_pwm = BASE_PWM

    else:
        // 階段 3: 停止
        complete = true
```

**參數**：
```
EXIT_WINDOW_MIN = 2000   // 出場窗口：至少等 2 秒
EXIT_WINDOW_MAX = 15000  // 出場窗口：最多 15 秒
EXIT_CONFIRM = 6         // 確認計數 300ms
EXIT_TURN = 22           // 右轉 800ms (6+16)
EXIT_TOTAL = 62          // 總共 2800ms (6+16+40)
```

### 2.3 控制優先級（覆蓋 vs 融合）

**關鍵改進**：採用「優先級覆蓋」而非純「加權融合」

```cpp
// 每個控制週期
void updateControl(int front_dist, int right_dist) {

    // ===== 穩定期：剛轉完彎，防止抖動 =====
    if (stable_timer > 0) {
        stable_timer--;
        goto wall_follow;           // 強制沿牆
    }

    // ===== 優先級 1: 原地轉彎（完全覆蓋）=====
    if (is_turning || front_dist < STOP_DIST) {
        if (!is_turning) {
            is_turning = true;
            turn_timer = 0;
            turn_confirm = 0;
        }

        turn_timer++;

        // 超時保護
        if (turn_timer > TURN_TIMEOUT) {
            is_turning = false;
            turn_timer = 0;
            stable_timer = TURN_STABLE;
            cornerCount++;
            goto wall_follow;
        }

        // 強制原地左轉
        left_pwm = -TURN_PWM;       // -60
        right_pwm = +TURN_PWM;      // +60

        // 檢查轉彎完成
        if (right_dist < 30) turn_confirm++;
        else turn_confirm = 0;

        if (turn_confirm >= 3) {
            is_turning = false;
            turn_timer = 0;
            stable_timer = TURN_STABLE;  // 進入穩定期
            cornerCount++;
        }
        return;  // 不執行後續邏輯
    }

    // ===== 優先級 2: 出場（完全覆蓋）=====
    if (exit_counter >= EXIT_CONFIRM) {
        // 出場邏輯（右轉 → 直走 → 停止）
        executeExit();
        return;
    }

wall_follow:
    // ===== 優先級 3: 沿牆 + 減速避障（加權融合）=====
    // 沿牆行為
    float error = TARGET_DIST - right_dist;
    float angular_wall = KP * error;
    angular_wall = clamp(angular_wall, -MAX_ANGULAR, +MAX_ANGULAR);

    // 避障行為（僅在 15-40cm 區間參與融合）
    float avoid_weight = 0;
    float angular_avoid = 0;
    if (front_dist < SLOW_DIST) {
        avoid_weight = (SLOW_DIST - front_dist) / (SLOW_DIST - STOP_DIST);
        avoid_weight = clamp(avoid_weight, 0, 0.8);  // 最多 80%
        angular_avoid = 0.3;  // 溫和左轉
    }

    // 加權融合
    float wall_weight = 1.0 - avoid_weight;
    float angular = wall_weight * angular_wall + avoid_weight * angular_avoid;

    // 轉換為 PWM
    left_pwm  = BASE_PWM * (1 - angular);
    right_pwm = BASE_PWM * (1 + angular);
}
```

**新增參數**：
```
TURN_TIMEOUT = 40        // 轉彎超時 (2 秒，從 3 秒縮短)
TURN_STABLE = 3          // 穩定期 (150ms)
TURN_FORWARD_MIN = 10    // 轉彎後最小前進 (500ms)
TURN_PWM = 60            // 原地轉彎 PWM
BASE_PWM = 60            // 基礎 PWM (從 80 降低，增加反應時間)
```

**優先級順序**：
```
原地轉彎 > 出場 > 沿牆+避障融合
   │         │         │
   └─ 覆蓋 ──┴─ 覆蓋 ──┴─ 融合
```

### 2.4 流程圖（無狀態切換）

```
┌─────────────────────────────────────────────────────────┐
│                  主控制迴圈 (20Hz)                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ 1. 讀取感測器                                    │   │
│  │    front_dist = readFrontUltrasonic()           │   │
│  │    right_dist = readRightUltrasonic()           │   │
│  └──────────────────────┬──────────────────────────┘   │
│                         │                               │
│  ┌──────────────────────▼──────────────────────────┐   │
│  │ 2. 並行計算三個行為                              │   │
│  │                                                  │   │
│  │    ┌────────────┐ ┌────────────┐ ┌────────────┐ │   │
│  │    │ 沿牆行為   │ │ 避障行為   │ │ 出場行為   │ │   │
│  │    │ angular_w  │ │ angular_a  │ │ angular_e  │ │   │
│  │    │ weight_w   │ │ weight_a   │ │ weight_e   │ │   │
│  │    └────────────┘ └────────────┘ └────────────┘ │   │
│  └──────────────────────┬──────────────────────────┘   │
│                         │                               │
│  ┌──────────────────────▼──────────────────────────┐   │
│  │ 3. 權重正規化 + 融合                             │   │
│  │    angular = w_w * a_w + w_a * a_a + w_e * a_e  │   │
│  └──────────────────────┬──────────────────────────┘   │
│                         │                               │
│  ┌──────────────────────▼──────────────────────────┐   │
│  │ 4. 輸出馬達 PWM                                  │   │
│  │    left_pwm  = BASE * (1 - angular)             │   │
│  │    right_pwm = BASE * (1 + angular)             │   │
│  └──────────────────────┬──────────────────────────┘   │
│                         │                               │
│  ┌──────────────────────▼──────────────────────────┐   │
│  │ 5. 檢查終止條件                                  │   │
│  │    if exit_complete || timeout → 停止           │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 3. 資料流分析

### 3.1 感測器資料流

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  前方超聲波   │────▶│   中值濾波   │────▶│  front_dist  │
└──────────────┘     └──────────────┘     └──────────────┘

┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  右側超聲波   │────▶│   中值濾波   │────▶│  right_dist  │
└──────────────┘     └──────────────┘     └──────────────┘
```

**中值濾波**：
- 保留最近 3 筆有效讀數
- 輸出中位數
- 濾除瞬間雜訊

### 3.2 控制資料流

```
                    ┌─────────────────────┐
  right_dist ──────▶│                     │
                    │   行為融合控制       │──────▶ left_pwm
  front_dist ──────▶│                     │──────▶ right_pwm
                    │   - 沿牆行為        │
  cornerCount ─────▶│   - 避障行為        │──────▶ vacuum_state
                    │   - 出場行為        │
                    └─────────────────────┘
                              │
                              ▼
                        cornerCount++
                        exit_counter
```

### 3.3 通訊資料流

```
┌───────────────────────────────────────────────────────────┐
│                     Raspberry Pi                          │
│                                                           │
│  Camera ──▶ 紅色偵測 ──▶ red_detected (bool)              │
│                              │                            │
│                              ▼                            │
│                     ┌────────────────┐                    │
│                     │ 狀態變化時發送  │                    │
│                     └────────┬───────┘                    │
│                              │                            │
└──────────────────────────────┼────────────────────────────┘
                               │ Serial (VACUUM_ON/OFF)
                               ▼
┌──────────────────────────────────────────────────────────┐
│                      Arduino                              │
│                                                           │
│  ┌─────────────┐                                         │
│  │ 指令解析     │──▶ vacuum_command ──▶ 繼電器控制        │
│  └─────────────┘                                         │
│                                                           │
└──────────────────────────────────────────────────────────┘
```

---

## 4. 時序分析

### 4.1 Arduino 主迴圈時序

```
┌─────────────────────────────────────────────────────────┐
│                    20Hz 主迴圈 (50ms)                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  0ms    ┌─────────────────┐                            │
│         │ 讀取超聲波 (交替) │ ~5ms                       │
│  5ms    └─────────────────┘                            │
│         ┌─────────────────┐                            │
│         │ 檢查 Serial 指令 │ ~1ms                       │
│  6ms    └─────────────────┘                            │
│         ┌─────────────────┐                            │
│         │ 更新導航控制     │ ~1ms                       │
│  7ms    └─────────────────┘                            │
│         ┌─────────────────┐                            │
│         │ 輸出馬達 PWM     │ ~1ms                       │
│  8ms    └─────────────────┘                            │
│         ┌─────────────────┐                            │
│         │ 等待下一週期     │ ~42ms                      │
│ 50ms    └─────────────────┘                            │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 4.2 超聲波交替讀取

```
週期 1:  ────[前方超聲波]────────────────
週期 2:  ────────────────[右側超聲波]────
週期 3:  ────[前方超聲波]────────────────
週期 4:  ────────────────[右側超聲波]────
```

**理由**：
- 避免兩個超聲波同時發射產生干擾
- 每個超聲波實際更新率 = 10 Hz

### 4.3 紅色偵測時序 (Pi)

```
┌─────────────────────────────────────────────────────────┐
│                  背景執行緒 (10 FPS)                     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  0ms    ┌─────────────────┐                            │
│         │ 擷取影像        │ ~10ms                       │
│ 10ms    └─────────────────┘                            │
│         ┌─────────────────┐                            │
│         │ HSV 轉換 + 遮罩  │ ~20ms                       │
│ 30ms    └─────────────────┘                            │
│         ┌─────────────────┐                            │
│         │ 輪廓偵測        │ ~10ms                       │
│ 40ms    └─────────────────┘                            │
│         ┌─────────────────┐                            │
│         │ 發送指令 (若狀態變化) │ ~5ms                  │
│ 45ms    └─────────────────┘                            │
│         ┌─────────────────┐                            │
│         │ 等待下一週期     │ ~55ms                      │
│ 100ms   └─────────────────┘                            │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 5. 控制演算法分析

### 5.1 P-Control 沿牆控制

**數學模型**：

```
輸入: right_dist (右側距離, cm)
輸出: left_pwm, right_pwm

error = TARGET_DIST - right_dist
      = 15 - right_dist

angular = Kp * error
        = 0.02 * error

angular = clamp(angular, -0.3, +0.3)

left_pwm  = BASE_PWM * (1 - angular)
right_pwm = BASE_PWM * (1 + angular)
```

**行為分析**：

| right_dist | error | angular | left_pwm | right_pwm | 行為 |
|------------|-------|---------|----------|-----------|------|
| 5 cm | +10 | +0.2 | 48 | 72 | 右轉（遠離牆） |
| 10 cm | +5 | +0.1 | 54 | 66 | 輕微右轉 |
| 15 cm | 0 | 0 | 60 | 60 | 直走 |
| 20 cm | -5 | -0.1 | 66 | 54 | 輕微左轉 |
| 25 cm | -10 | -0.2 | 72 | 48 | 左轉（靠近牆） |

**參數選擇理由**：

| 參數 | 數值 | 理由 |
|------|------|------|
| TARGET_DIST | 15 cm | 超聲波有效範圍中間值 |
| Kp | 0.02 | 保守值，避免震盪 |
| MAX_ANGULAR | 0.3 | 限制最大轉向幅度 |
| BASE_PWM | 60 | 低速穩定，約 20% 動力 |

### 5.2 避障行為（角落處理）

**連續控制方式**：
- 不使用「角落模式」狀態機
- 避障行為的權重隨距離連續變化
- 當 avoid_weight → 1.0 時，自然產生原地左轉效果

**權重曲線**：
```
avoid_weight
    1.0 ─────┐
             │
             │
    0.0 ─────┴─────────────────▶ front_dist
           20cm              40cm
```

**角落轉彎效果**：
- 前方 < 20cm 時：avoid_weight = 1.0, angular = +0.5
- 左輪 PWM = 60 * (1 - 0.5) = 30（大幅減速）
- 右輪 PWM = 60 * (1 + 0.5) = 90
- 產生接近原地左轉的效果
- 當 front_dist > 40cm 後，自動恢復沿牆控制

### 5.3 出場行為

**觸發條件**（連續判斷，無狀態切換）：
```
每個控制週期:
    if cornerCount >= 4 && right_dist > 50cm:
        exit_counter++
    else:
        exit_counter = 0

    if exit_counter >= 6:  // 持續 300ms
        exit_weight = 1.0
        // 此時 wall_weight 和 avoid_weight 被設為 0
```

**出場行為輸出**：
```
階段 1 (exit_counter < 16):  // 前 800ms
    angular_exit = -0.3      // 右轉朝向出口

階段 2 (exit_counter >= 16): // 之後
    angular_exit = 0         // 直走出場
    linear_exit = BASE_PWM

終止條件:
    exit_counter >= 50       // 2500ms 後停止
```

---

## 6. 風險分析

### 6.1 技術風險

| 風險 | 可能性 | 影響 | 緩解措施 |
|------|--------|------|----------|
| EMI 導致重置 | 中 | 高 | Watchdog + 啟動延遲 |
| 超聲波誤讀 | 高 | 中 | 中值濾波 + 邊界檢查 |
| 角落轉彎不足 | 中 | 低 | 沿牆控制自動修正 |
| 紅色誤偵測 | 低 | 低 | 面積閾值 + 連續確認 |
| 出口誤判 | 低 | 高 | 持續時間確認 |

### 6.2 失效模式分析

| 失效模式 | 原因 | 後果 | 偵測方法 | 應對 |
|----------|------|------|----------|------|
| 馬達不轉 | PWM < 45 | 停滯 | 運動超時 | 提高 BASE_PWM |
| 撞牆 | 超聲波失效 | 卡住 | front_dist 持續 < 10 | 強制停止 |
| 繞圈 | 轉彎不足 | 無法出場 | 運行超時 | 停止 |
| 吸紅色 | 偵測延遲 | 失分 | 事後檢查 | 提高檢查頻率 |

---

## 7. 效能預估

### 7.1 時間預估

| 階段 | 距離/角度 | 速度 | 預估時間 |
|------|-----------|------|----------|
| 進場 | 0.5 m | 0.2 m/s | 2.5 s |
| 沿牆 (單邊) | 3 m | 0.2 m/s | 15 s |
| 角落 (單次) | 90° | 112°/s | 0.8 s |
| 總共沿牆 | 12 m | 0.2 m/s | 60 s |
| 角落 (4次) | 360° | - | 3.2 s |
| 出場 | 1 m | 0.2 m/s | 5 s |
| **總計** | | | **~70 s** |

### 7.2 資源使用

| 資源 | Arduino | Pi |
|------|---------|-----|
| CPU 使用率 | ~10% | ~30% |
| RAM 使用 | ~500 bytes | ~50 MB |
| Serial 頻寬 | < 1% | < 1% |

---

## 8. 測試策略概述

### 8.1 單元測試

| 模組 | 測試項目 |
|------|----------|
| 超聲波濾波 | 注入雜訊，驗證濾波效果 |
| 沿牆行為 | 驗證各距離對應的 angular 輸出 |
| 避障行為 | 驗證權重曲線正確 |
| 行為融合 | 驗證權重正規化和加權混合 |

### 8.2 整合測試

| 場景 | 驗證項目 |
|------|----------|
| 直線沿牆 | 距離維持 10-20 cm |
| 單角落轉彎 | 成功轉過角落 |
| 完整單圈 | 4 角落 + 出場 |
| 紅色閃避 | 吸塵器正確開關 |

---

## 附錄 A：需求追溯矩陣

| 需求 ID | 對應模組 | 對應行為 |
|---------|----------|----------|
| FR-001 | 行為融合控制 | 沿牆行為 |
| FR-002 | 行為融合控制 | 避障行為 |
| FR-003 | 吸塵器控制, 通訊 | (Pi 紅色偵測) |
| FR-004 | 行為融合控制 | 出場行為 |
| FR-005 | 吸塵器控制 | (Pi 指令) |
| FR-006 | 行為融合控制 | 終止條件 |

## 附錄 B：Pi 擴展功能 - 視覺里程計

### B.1 設計目標

利用 Pi 閒置算力，實現**輔助性**位置估算功能：
- **不影響 Arduino 控制** - 純觀測，不介入即時控制
- **事後分析** - 記錄軌跡供除錯與調參
- **可選功能** - 即使失效也不影響主任務

### B.2 技術方案：光流法 (Optical Flow)

**選擇理由**：
| 方案 | 優點 | 缺點 | 結論 |
|------|------|------|------|
| 特徵點追蹤 (ORB) | 精度高 | 計算量大，需 GPU | ❌ |
| 稀疏光流 (Lucas-Kanade) | 輕量 | 需特徵點 | △ |
| 稠密光流 (Farneback) | 穩定 | 中等計算量 | ✅ |

**選用 Farneback 稠密光流**：Pi 4 可達 10 FPS，足夠記錄軌跡。

### B.3 演算法流程

```
影像 (320x240)
     │
     ▼
┌─────────────────┐
│ 灰階轉換        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Farneback 光流   │ ← 前一幀
│ calcOpticalFlow │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 計算平均位移     │
│ dx, dy (像素)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 像素→實際距離    │
│ scale ≈ 0.5cm/px│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 累積位置        │
│ x += dx * scale │
│ y += dy * scale │
└─────────────────┘
```

### B.4 校準方法

**像素-距離比例校準**：
1. 將車放在有格線的地面（如 10cm 格子）
2. 手動推車直走 50cm
3. 記錄光流累積像素位移
4. `scale = 50cm / 累積像素`

**典型值**：320x240 @ 高度 15cm，約 0.4~0.6 cm/pixel

### B.5 資料結構

```python
@dataclass
class OdometryData:
    timestamp: float      # 時間戳
    x: float              # 累積 X (cm)
    y: float              # 累積 Y (cm)
    theta: float          # 估算角度 (rad, 由 dx/dy 推算)
    confidence: float     # 信心度 (光流品質)
```

### B.6 資料記錄格式

```json
{
  "run_id": "2025-12-06_143052",
  "events": [
    {"t": 0.0, "type": "start", "x": 0, "y": 0},
    {"t": 1.5, "type": "corner", "corner_num": 1, "x": 285, "y": 12},
    {"t": 3.2, "type": "red_detected", "x": 280, "y": 150},
    {"t": 3.8, "type": "red_cleared", "x": 275, "y": 180},
    {"t": 12.5, "type": "exit", "x": 15, "y": 5}
  ],
  "trajectory": [
    {"t": 0.0, "x": 0, "y": 0},
    {"t": 0.1, "x": 2.5, "y": 0.1},
    ...
  ]
}
```

### B.7 限制與注意事項

| 限制 | 說明 |
|------|------|
| 累積漂移 | 長時間運行會累積誤差，僅供參考 |
| 光線依賴 | 低光環境精度下降 |
| 地面紋理 | 純色地面光流無法追蹤 |
| 非即時控制 | 不可用於閉迴路控制 |

### B.8 與主系統整合

```
┌─────────────────────────────────────────────────────────┐
│                    Raspberry Pi                         │
│                                                         │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐ │
│  │ 紅色偵測    │    │ 視覺里程計   │    │ 資料記錄    │ │
│  │ Thread 1   │    │ Thread 2    │    │ Thread 3   │ │
│  │ 10 FPS     │    │ 10 FPS      │    │ 事件驅動   │ │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘ │
│         │                  │                  │        │
│         └──────────────────┼──────────────────┘        │
│                            ▼                           │
│                    ┌─────────────┐                     │
│                    │ 主控制器    │                     │
│                    │ V3Controller│                     │
│                    └──────┬──────┘                     │
│                           │                            │
│                    ┌──────▼──────┐                     │
│                    │ Serial 通訊 │ ─────────▶ Arduino  │
│                    └─────────────┘                     │
└─────────────────────────────────────────────────────────┘
```

**關鍵原則**：視覺里程計失效不影響吸塵器控制與 Arduino 通訊。

---

## 附錄 C：修訂歷史

| 版本 | 日期 | 變更說明 |
|------|------|----------|
| 1.0 | 2025-12-06 | 初版 |
| 1.1 | 2025-12-06 | 新增轉彎超時保護、穩定期、視覺里程計 |
